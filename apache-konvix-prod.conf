# Configuration Apache pour Konvix E-commerce (Production)
# Fichier à placer dans /etc/apache2/sites-available/konvix.fr.conf sur le VPS
# Puis activer avec : sudo a2ensite konvix.fr.conf && sudo systemctl reload apache2

# HTTP Virtual Host (redirige vers HTTPS)
<VirtualHost *:80>
    ServerName konvix.fr
    ServerAlias www.konvix.fr
    
    # Redirection permanente vers HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    ErrorLog ${APACHE_LOG_DIR}/konvix-error.log
    CustomLog ${APACHE_LOG_DIR}/konvix-access.log combined
</VirtualHost>

# HTTPS Virtual Host (configuré après installation SSL)
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName konvix.fr
    ServerAlias www.konvix.fr
    ServerAdmin admin@konvix.fr
    
    # Répertoire racine pointant vers public/
    DocumentRoot /var/www/konvix.fr/public
    
    # Configuration du répertoire public/
    <Directory /var/www/konvix.fr/public>
        # Permet l'utilisation du .htaccess
        AllowOverride All
        
        # Autorise l'accès à tous
        Require all granted
        
        # Options de sécurité
        Options -Indexes +FollowSymLinks
        
        # Configuration du moteur de réécriture
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Gestion de l'en-tête Authorization
            RewriteCond %{HTTP:Authorization} ^(.*)
            RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
            
            # Redirection vers le contrôleur frontal
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php [QSA,L]
        </IfModule>
        
        # Protection contre les injections
        <IfModule mod_headers.c>
            # Sécurité des en-têtes
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "SAMEORIGIN"
            Header set X-XSS-Protection "1; mode=block"
            Header set Referrer-Policy "strict-origin-when-cross-origin"
            
            # Cache control pour les assets
            <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|swf|woff|woff2|ttf|eot)$">
                Header set Cache-Control "max-age=31536000, public"
            </FilesMatch>
        </IfModule>
    </Directory>
    
    # Configuration spécifique pour le répertoire uploads
    <Directory /var/www/konvix.fr/public/uploads>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Empêcher l'exécution de PHP dans uploads
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Configuration spécifique pour le répertoire build (assets compilés)
    <Directory /var/www/konvix.fr/public/build>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Cache long pour les assets versionnés
        <IfModule mod_headers.c>
            Header set Cache-Control "max-age=31536000, public, immutable"
        </IfModule>
    </Directory>
    
    # Bloquer l'accès aux fichiers sensibles
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Bloquer fichiers de configuration et sensibles
    <FilesMatch "(?i)^(\.git|\.env.*|composer\.(json|lock)|package(-lock)?\.json|.*\.sql|.*\.bak|.*\.backup)$">
        Require all denied
    </FilesMatch>
    
    # Bloquer l'accès aux répertoires sensibles
    <DirectoryMatch "/(config|src|var|vendor|migrations|templates|translations|bin)">
        Require all denied
    </DirectoryMatch>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/konvix-error.log
    CustomLog ${APACHE_LOG_DIR}/konvix-access.log combined
    
    # Configuration SSL (sera ajoutée automatiquement par Certbot)
    # SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/konvix.fr/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/konvix.fr/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>

# Configuration de sécurité générale
<IfModule mod_security2.c>
    # Active ModSecurity
    SecRuleEngine On
</IfModule>

# Compression GZIP pour améliorer les performances
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Limites PHP recommandées (à configurer aussi dans php.ini)
# upload_max_filesize = 10M
# post_max_size = 10M
# memory_limit = 256M
# max_execution_time = 60

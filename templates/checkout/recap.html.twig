{% extends 'base.html.twig' %}

{% block body %}
	<div class="container my-5">
		<div class="row g-4">
			<div class="col-lg-8">
				<div class="card p-4 mb-4">
					<h4 class="mb-3">
						<i class="bi bi-file-earmark-text"></i>
						Récapitulatif de votre commande</h4>
					<table class="table table-bordered">
						<thead class="table-light">
							<tr>
								<th>Produit</th>
								<th>Prix Unit.</th>
								<th>Qté</th>
								<th>Total</th>
							</tr>
						</thead>
						<tbody>
							{% set total = 0 %}
							{% for item in cart.items %}
								<tr>
									<td>{{ item.product.name }}</td>
									<td>{{ item.product.price|number_format(2, ',', ' ') }}
										€</td>
									<td>{{ item.quantity }}</td>
									<td>{{ (item.product.price * item.quantity)|number_format(2, ',', ' ') }}
										€</td>
								</tr>
								{% set total = total + (item.product.price * item.quantity) %}
							{% endfor %}
						</tbody>
					</table>
					<div class="mt-3">
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Sous-total HT :</div>
							<div class="col-5 text-end">{{ (total / 1.2)|number_format(2, ',', ' ') }}
								€</div>
						</div>
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">TVA (20%) :</div>
							<div class="col-5 text-end">{{ (total - (total / 1.2))|number_format(2, ',', ' ') }}
								€</div>
						</div>
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Frais de livraison :</div>
							<div class="col-5 text-end">{{ transporteur.price|default(0)|number_format(2, ',', ' ') }}
								€</div>
						</div>
						<div class="row mb-2" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Mode de livraison :</div>
							<div class="col-5 text-end">
								<span style="font-weight:600; color:#222;">{{ transporteur.name|default('Non renseigné') }}</span>
							</div>
						</div>
						{% if cart.reduction is defined and cart.reduction > 0 %}
							<div class="row mb-1" style="color:#d32f2f; font-size:1.08em;">
								<div class="col-7">Réduction :</div>
								<div class="col-5 text-end">-{{ cart.reduction|number_format(2, ',', ' ') }}
									€</div>
							</div>
						{% endif %}
						<hr style="margin:10px 0 14px 0;">
						<div class="row align-items-center">
							<div class="col-7" style="font-size:1.13em; font-weight:700; color:#14287b;">TOTAL TTC :</div>
							<div class="col-5 text-end" style="font-size:1.35em; font-weight:700; color:#1563d7;">
								{{ ((cart.totalAvecPromo is defined ? cart.totalAvecPromo : cart.total|default(0)) + transporteur.price|default(0))|number_format(2, ',', ' ') }}
								€</div>
						</div>
						{# Bandeau confirmation commande #}
						{% for message in app.flashes('success') %}
							<div class="mt-3" style="background:#e6f4e6; color:#205c20; border-left:6px solid #2e7d32; font-size:1.13em; font-weight:500; padding:14px 18px; margin-bottom:10px; display:flex; align-items:center;">
								<span style="font-size:1.3em; margin-right:10px;">✅</span>
								<strong>Confirmation :</strong>
								{{ message }}
							</div>
						{% endfor %}
					</div>
					<div class="d-flex flex-column gap-3 mt-4 mb-2">
						<a href="{{ path('checkout_pay_stripe') }}" class="btn w-100 d-flex align-items-center justify-content-center" style="background:#1563d7; color:#fff; font-size:1.18em; font-weight:600; border:none; border-radius:8px; box-shadow:0 2px 8px #1563d722; padding:0.85em 0;">
							<i class="bi bi-credit-card me-2"></i>Payer par Carte ({{ (total + transporteur.price|default(0))|number_format(2, ',', ' ') }}
							€)
						</a>
						<a href="{{ path('checkout_pay_paypal') }}" class="btn w-100 d-flex align-items-center justify-content-center" style="background:linear-gradient(90deg,#ffb347 0%,#ff6961 100%); color:#fff; font-size:1.18em; font-weight:600; border:none; border-radius:8px; box-shadow:0 2px 8px #ff696122; padding:0.85em 0;">
							<i class="bi bi-paypal me-2"></i>Payer avec PayPal ({{ (total + transporteur.price|default(0))|number_format(2, ',', ' ') }}
							€)
						</a>
					</div>
					<div class="alert mt-3" style="background:#eaf6fd; color:#1563d7; border:1.5px solid #b2d6f6; font-size:1.08em;">
						<i class="bi bi-shield-lock"></i>
						Vos données de paiement sont sécurisées. Nous ne stockons aucune information de carte bancaire.
					</div>
				</div>
			</div>
			<div class="col-lg-4">
				<div class="card p-3 mb-3">
					<h5 class="mb-2" style="color:#14287b; font-size:1.15rem;">
						<i class="bi bi-geo-alt"></i>
						Adresse de livraison
					</h5>
					{% if address %}
						<div>
							{% if app.user %}
								<span style="font-weight:600;">{{ app.user.firstName }}
									{{ app.user.lastName }}</span><br>
							{% endif %}
							{{ address.address }}<br>
							{{ address.city }}<br>
							{{ address.zip }}
							{{ address.country }}<br>
							{% if address.phone %}
								<span class="fw-bold">Tél :</span>
								{{ address.phone }}<br>
							{% endif %}
							<div class="mt-2"></div>
						</div>
					{% else %}
						<div class="text-danger">Aucune adresse renseignée.</div>
					{% endif %}
				</div>
				<div class="card p-3 mb-3">
					<h5 class="mb-2">
						<i class="bi bi-journal-text"></i>
						Adresse de facturation</h5>
					{% if address %}
						<div>{{ address.address }}<br>{{ address.city }}<br>{{ address.zip }}<br>{{ address.country }}</div>
					{% else %}
						<div class="text-danger">Aucune adresse renseignée.</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% extends 'base.html.twig' %}

{% block body %}

	<div class="container my-5">
		<div class="row g-4">
			<div class="col-lg-8 col-12">
				<div class="card p-4 mb-4 h-100" style="border:1.5px solid #d1d5db; border-radius:14px; background:#fff;">
					<h4 class="mb-3" style="color:#14287b; font-size:1.55rem; font-weight:700;">
						<i class="bi bi-file-earmark-text"></i>
						Récapitulatif de votre commande
					</h4>
					<table class="table table-bordered">
						<thead class="table-light">
							<tr>
								<th>Produit</th>
								<th>Prix Unit.</th>
								<th>Qté</th>
								<th>Total</th>
							</tr>
						</thead>
						<tbody>
							{% set total = 0 %}
							{% for item in cart.items %}
								<tr>
									<td>{{ item.product.name }}</td>
									<td>{{ item.product.price|number_format(2, ',', ' ') }}
										€</td>
									<td>{{ item.quantity }}</td>
									<td>{{ (item.product.price * item.quantity)|number_format(2, ',', ' ') }}
										€</td>
								</tr>
								{% set total = total + (item.product.price * item.quantity) %}
							{% endfor %}
						</tbody>
					</table>
					<div class="mt-3">
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Sous-total HT :</div>
							<div class="col-5 text-end">{{ (total / 1.2)|number_format(2, ',', ' ') }}
								€</div>
						</div>
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">TVA (20%) :</div>
							<div class="col-5 text-end">{{ (total - (total / 1.2))|number_format(2, ',', ' ') }}
								€</div>
						</div>
						<div class="row mb-1" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Frais de livraison :</div>
							<div class="col-5 text-end">
								{{ transporteur.price|default(0)|number_format(2, ',', ' ') }} €
							</div>
						</div>
						<div class="row mb-2" style="color:#6c757d; font-size:1.08em;">
							<div class="col-7">Mode de livraison :</div>
							<div class="col-5 text-end">
								<span style="font-weight:600; color:#222;">
									{{ transporteur.name|default('Non renseigné') }}
								</span>
							</div>
						</div>
						{% if cart.reduction is defined and cart.reduction > 0 %}
							<div class="row mb-1" style="color:#d32f2f; font-size:1.08em;">
								<div class="col-7">Réduction :</div>
								<div class="col-5 text-end">-{{ cart.reduction|number_format(2, ',', ' ') }} €</div>
							</div>
						{% endif %}
						<hr style="margin:10px 0 14px 0;">
						<div class="row align-items-center">
							<div class="col-7" style="font-size:1.13em; font-weight:700; color:#14287b;">TOTAL TTC :</div>
							<div class="col-5 text-end" style="font-size:1.35em; font-weight:700; color:#1563d7;">
								{{ ((cart.totalAvecPromo is defined ? cart.totalAvecPromo : cart.total|default(0)) + transporteur.price|default(0))|number_format(2, ',', ' ') }} €
							</div>
						</div>
						{# Bandeau confirmation commande #}
						{% for message in app.flashes('success') %}
							<div class="mt-3" style="background:#e6f4e6; color:#205c20; border-left:6px solid #2e7d32; font-size:1.13em; font-weight:500; padding:14px 18px; margin-bottom:10px; display:flex; align-items:center;">
								<span style="font-size:1.3em; margin-right:10px;">✅</span>
								<strong>Confirmation :</strong>
								{{ message }}
							</div>
						{% endfor %}
					</div>
					{# Bandeau confirmation commande #}
					{% for message in app.flashes('success') %}
						<div class="mt-3" style="background:#e6f4e6; color:#205c20; border-left:6px solid #2e7d32; font-size:1.13em; font-weight:500; padding:14px 18px; margin-bottom:10px; display:flex; align-items:center;">
							<span style="font-size:1.3em; margin-right:10px;">✅</span>
							<strong>Confirmation :</strong>
							{{ message }}
						</div>
					{% endfor %}

					{# Boutons paiement #}
					<form method="post" action="{{ path('checkout_recap') }}" class="d-flex flex-column gap-3 mt-4 mb-2">
						<button type="submit" class="btn w-100 d-flex align-items-center justify-content-center" style="background:linear-gradient(90deg,#3ec6fa 0%,#18e2d4 100%); color:#fff; font-size:1.18em; font-weight:600; border:none; border-radius:8px; box-shadow:0 2px 8px #18e2d422; padding:0.85em 0;">
							<span style="font-size:1.3em; margin-right:10px;">✅</span>
							Valider ma commande
						</button>
					</form>

					{# Bloc info paiement sécurisé #}
					<div class="alert mt-3" style="background:#eaf6fd; color:#1563d7; border:1.5px solid #b2d6f6; font-size:1.08em;">
						<i class="bi bi-info-circle-fill"></i>
						Vérifiez bien le contenu de votre commande et votre mode de livraison avant de valider.
					</div>
				</div>
			</div>
			<div class="col-lg-4 col-12 d-flex flex-column gap-3">
				<div class="card p-3 mb-3 flex-fill">
					<h5 class="mb-2 mb-5" style="color:#14287b; font-size:1.45rem;">
						<i class="bi bi-person"></i>
						Mes informations</h5>
					<div class="row">
						<div class="col-12 mb-3">
							<div style="border:1px solid #d1d5db; border-radius:8px; padding:12px; margin-bottom:18px;">
								<h6 class="fw-bold mb-1" style="color:#14287b; font-size:1.15rem;">
									<i class="bi bi-journal-text"></i>
									Adresse de facturation</h6>
								{% if app.user %}
									<div>
										{{ app.user.firstName }}
										{{ app.user.lastName }}<br>
										{{ app.user.address }}<br>
										{{ app.user.city }}<br>
										{{ app.user.zip }}
										{{ app.user.country }}<br>
										{% if app.user.phone %}
											<span class="fw-bold">Tél :</span>
											{{ app.user.phone }}
										{% endif %}
									</div>
								{% else %}
									<div class="text-danger">Aucune adresse renseignée.</div>
								{% endif %}
							</div>
						</div>
						<div class="col-12">
							<div style="border:1px solid #d1d5db; border-radius:8px; padding:12px; margin-bottom:8px;">
								<h6 class="fw-bold mb-1" style="color:#14287b; font-size:1.15rem;">
									<i class="bi bi-geo-alt"></i>
									Adresse de livraison
								</h6>
								{% if app.user %}
									<div>
										{{ app.user.firstName }}<br>
										{{ app.user.lastName }}<br>
										{{ app.user.address }}<br>
										{{ app.user.city }}<br>
										{{ app.user.zip }}<br>
										{{ app.user.country }}<br>
										{% if app.user.phone %}
											<span class="fw-bold">Tél :</span>
											{{ app.user.phone }}<br>
										{% endif %}
										<div class="mt-2">
											<a href="{{ path('app_profile_edit') }}" class="btn btn-outline-primary w-100 btn-sm" style="font-size:0.95em;">
												<i class="bi bi-pencil"></i>
												Modifier (si l'adresse de livraison est différente)
											</a>
										</div>
									</div>
								{% else %}
									<div class="text-danger">Aucune adresse renseignée.</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
